# PULSE v2 — Requirements

## 1. Контекст и цели

PULSE v1 уже решает базовую задачу:
- передаёт статус обучения через один JSON-снапшот `training_status.json`;
- используется Rust backend'ом и TrainingPanel для отображения состояния тренинга;
- интегрирован с Flows v1 через TRAIN шаги (run_training).

Ограничения PULSE v1:
- только поллинг по файлу (нет событий);
- один "плоский" снапшот — нет истории шагов/метрик;
- слабая интеграция с Flows History (нет связки training_run ↔ flow_run);
- нет богатой модели ошибок/метрик.

**Цель PULSE v2** — спроектировать event-driven протокол статусов обучения, который:
- даёт real-time ощущение прогресса;
- хорошо интегрируется с Flows и их историей;
- остаётся совместимым с PULSE v1 (можно собрать v1-снапшот из v2-событий);
- не ломает существующую архитектуру v0.3.x.

---

## 2. Источники событий

PULSE v2 должен поддерживать следующие источники:

1. **Training процессы (Python / run_training):**
   - базовый сценарий: пользователь запускает обучение из TrainingPanel;
   - Flows вызывают тот же API, но в контексте flow-шагов.

2. **Flows v1 (Flow Manager):**
   - TRAIN шаги внутри flow должны уметь:
     - инициировать training_run;
     - получать события прогресса/ошибок;
     - связывать training_run с flow_run.

3. *(Опционально, не обязательно в первой итерации v2)*:
   - INDEX шаги (индексация) — если потребуется метрики индексации.

---

## 3. Функциональные требования

### 3.1. Статусы обучения

PULSE v2 должен уметь описывать следующие состояния процесса обучения:

- `idle` — нет активного обучения;
- `preparing` — подготовка (загрузка данных, проверка конфига);
- `running` — обучение идёт;
- `cooling_down` — post-processing (сохранение, очистка ресурсов);
- `done` — успешно завершено;
- `error` — завершено с ошибкой;
- *(опционально)* `cancelled` — принудительно остановлено пользователем.

Для каждого события изменения статуса должно быть:
- `training_id` — идентификатор конкретного запуска обучения;
- `timestamp` — время события;
- краткое текстовое описание (message).

### 3.2. Прогресс обучения

PULSE v2 должен уметь передавать прогресс как минимум на уровне:

- `epoch` и `total_epochs`;
- *(опционально)* `step` / `total_steps` внутри эпохи;
- вычислимый процент:
  - UI должен иметь достаточно данных, чтобы считать `%` самостоятельно;
  - сам протокол не обязан хранить готовое поле `progress`.

Требование:
- события прогресса должны быть достаточно частыми для UX,
  но не спамить UI (детализация настраивается в реализации — в техспеке).

### 3.3. Метрики

Минимальный набор метрик для v2:

- `loss` — текущая функция потерь;
- *(опционально, по возможности)*:
  - `time_per_epoch`;
  - `samples_per_second` / `tokens_per_second`.

Требование:
- метрики должны быть **опциональными**: отсутствие метрик не должно ломать протокол;
- UI должен уметь gracefully деградировать, если часть метрик не приходит.

### 3.4. Ошибки

PULSE v2 должен уметь описывать ошибки в виде событий:

- `error_code` — машиночитаемый код (например, `DATASET_NOT_FOUND`, `CUDA_OOM`);
- `message` — человекочитаемое описание;
- `is_retryable` — флаг, стоит ли предлагать пользователю "повторить попытку";
- *(опционально)* `details` — дополнительные данные (trace-id, контекст).

Требование:
- ошибка должна быть **отдельным типом события**, а не просто финальным статусом;
- UI должен иметь возможность:
  - показать краткую ошибку;
  - при желании дать доступ к деталям через History / Details.

### 3.5. Идентификаторы и множественные запуски

ПULSE v2 должен поддерживать несколько тренировок (поочерёдно и потенциально параллельно):

- `training_id` — уникальный ID одного запуска обучения;
- `flow_run_id` — *(опционально)* ID запуска flow, из которого родился training;
- события всегда привязаны к `training_id`.

Требование:
- UI TrainingPanel должен уметь:
  - показывать активный `training_id`;
  - переключаться между текущим и последними завершёнными (через History).

---

## 4. Интеграция с Flows v1 и Observability

### 4.1. Связь тренировки с flow-запуском

PULSE v2 должен позволять:

- связать `training_id` с:
  - `flow_run_id`;
  - `flow_id` и `flow_step_id`;

чтобы:

- в Flows History можно было:
  - увидеть, что внутри конкретного шага TRAIN происходило обучение;
  - провалиться в детали тренировки (статусы, метрики, ошибки).

### 4.2. Логирование и история

Требования:

- события PULSE v2 должны:
  - либо напрямую писать в отдельный лог (например, `logs/training/*.jsonl`);
  - либо быть легко сериализуемыми из in-memory структуры для записи Flow History.

- при просмотре истории Flows:
  - пользователь должен видеть как минимум:
    - факт, что TRAIN выполнялся,
    - итог (успех/ошибка),
    - базовое время работы и ключевые метрики.

---

## 5. Нефункциональные требования

### 5.1. Latency (задержка)

- Обновления прогресса и статусов должны доходить в UI:
  - **ориентир:** до 500ms "видимой задержки" для пользователя;
  - при этом не обязательно каждое внутреннее событие передавать 1:1.

- Должны быть механизмы:
  - дебаунса/агрегации событий;
  - ограничения частоты обновлений для UI.

### 5.2. Надёжность и устойчивость

PULSE v2 должен достойно вести себя при:

- падении Python-процесса;
- временных IO-ошибках;
- перезапуске приложения посреди обучения.

Требование:
- при повторном открытии приложения UI должен уметь:
  - восстановить последнее известное состояние `training_id`;
  - показать, что:
    - либо обучение завершилось (done/error),
    - либо статус "неизвестно / потерян контекст" — но честно.

### 5.3. Производительность и ресурсы

- PULSE v2 не должен:
  - создавать гигантские логи в рамках одного запуска обучения;
  - забивать UI сотнями событий в секунду.

Требование:
- протокол должен проектироваться с учётом:
  - ограничений по диску;
  - ограничений по памяти и CPU на стороне UI/таури.

---

## 6. Совместимость с PULSE v1

Требования совместимости:

1. PULSE v1 **остается официальным протоколом** для v0.3.x:
   - PULSE v2 вначале будет параллельным слоем.

2. PULSE v2 должен поддерживать:
   - возможность собрать PULSE v1-снапшот (`status`, `epoch`, `total_epochs`, `loss`, `message`, `timestamp`) из набора событий v2.

3. Переходный период:
   - TrainingPanel и FlowsPanel сначала могут работать:
     - либо только на v1,
     - либо в гибридном режиме (v2 для расширенной информации, v1 для fallback).

---

## 7. Out of Scope (для первой версии PULSE v2)

Чтобы не раздуть объём:

- Не требуем в v2:
  - продвинутый мониторинг VRAM/CPU/GPU;
  - сложные алерты и нотификации;
  - многопользовательский режим.

- Всё выше — кандидаты для **PULSE v2.1+ / v3**, но не блокеры для первой реализации v2.

---
