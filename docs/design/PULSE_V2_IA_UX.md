# PULSE v2 — Information Architecture & UX

Версия: draft v1  
Связанные документы:
- PULSE_V2_REQUIREMENTS.md
- PULSE_V2_TECH_SPEC.md (после этого документа)
- PULSE_V2_MIGRATION_PLAN.md

Цель этого документа — описать, **как PULSE v2 выглядит глазами пользователя и UI**, какие сущности и состояния должны быть доступны на уровне интерфейса и клиентского состояния, без привязки к конкретной реализации (Svelte/Tauri/Rust).

---

## 1. Ключевые сущности и связи (IA-уровень)

### 1.1. TrainingRun

Логическая сущность одного запуска обучения.

Обязательные поля на UX-уровне:

- `training_id` — уникальный ID запуска;
- `status` — текущее состояние (`idle`, `preparing`, `running`, `cooling_down`, `done`, `error`, `cancelled`);
- `profile_name` — человекочитаемое имя профиля/конфига обучения;
- `dataset_name` — человекочитаемое имя датасета (если применимо);
- `epochs_done` / `epochs_total`;
- `last_loss` — последняя известная величина loss;
- `started_at` / `finished_at` — временные метки;
- `source` — откуда запуск:
  - `manual` (из TrainingPanel),
  - `flow:<flow_id>` (из Flows).

Дополнительные UX-поля (derived, не обязательно в протоколе):

- `duration` (finished_at - started_at);
- `is_active` (status ∈ {preparing, running, cooling_down}).

### 1.2. FlowRun (контекст Flows v1)

Используется для отображения тренировки в истории flow.

Минимальные поля:

- `flow_run_id`;
- `flow_id`, `flow_name`;
- список шагов (`steps[]`), каждый шаг имеет:
  - `step_id`,
  - `step_type` (`STATUS`, `INDEX`, `TRAIN`, `GIT_PUSH`, …),
  - `status` (успех/ошибка/пропущен);
  - *(для TRAIN)* `training_id` (связка с TrainingRun).

### 1.3. TrainingSnapshot и TrainingTimeline

Для UI нужно два уровня представления:

1. **Snapshot** — "как дела прямо сейчас":
   - то, что по сути является развитием PULSE v1 JSON;
   - используется для отображения текущего состояния в TrainingPanel и в мини-карточках.

2. **Timeline** — "как всё развивалось":
   - набор событий (events) с временем;
   - используется для advanced UX (история, графики, детализация).

---

## 2. TrainingPanel — UX и состояние

### 2.1. Основные состояния TrainingPanel

TrainingPanel должен явно поддерживать следующие UX-состояния:

1. `idle` — обучения нет:
   - отображается пустое состояние, подсказка "Запустите обучение";
   - кнопка запуска доступна;
   - при наличии предыдущих запусков — виден последний результат / ссылка на History.

2. `preparing`:
   - статус "Подготовка: проверяем данные/конфиг…";
   - прогресс-бар может быть в состоянии "индетерминированный" (анимация);
   - кнопка "Отменить" (если есть техническая возможность) или явно `disabled`.

3. `running`:
   - статус "Обучение идёт";
   - прогресс по epoch (`epoch / total_epochs`);
   - при наличии — loss, скорость, другие метрики;
   - кнопка "Остановить" (если поддерживается) или `disabled`, но понятно, что идёт процесс.

4. `cooling_down`:
   - статус "Сохраняем результаты…";
   - прогресс может быть фиксированным (100%), но статус ещё не `done`;
   - это состояние помогает избежать ощущения "зависания" на конце.

5. `done`:
   - статус "Обучение завершено успешно";
   - показываются финальные метрики (loss, длительность);
   - доступны действия:
     - "Повторить обучение" (re-run),
     - "Открыть в Flows History" (если запуск был из flow).

6. `error`:
   - статус "Обучение завершилось с ошибкой";
   - краткое описание ошибки (из события PULSE v2);
   - если `is_retryable = true`, кнопка "Повторить попытку";
   - ссылка "Подробнее" → ведёт к логам / Flow History / подробностям.

7. *(опционально)* `cancelled`:
   - "Обучение отменено пользователем".

### 2.2. Layout TrainingPanel (логические зоны)

На UX-уровне TrainingPanel делится на зоны:

1. **Header**:
   - название панели,
   - текущий `profile_name` / `dataset_name`,
   - источник (`manual` / `flow`).

2. **Primary Status Zone**:
   - крупный статус (icon + текст: "Running", "Done", "Error");
   - подстрочный текст с message (обновляется событиями PULSE v2).

3. **Progress & Metrics**:
   - прогресс-бар по epoch:
     - `epoch / total_epochs`;
   - текущий `loss` (или "—" если нет данных);
   - при наличии — доп. метрики (скорость, время).

4. **Timeline / Details (в свернутом/развёрнутом виде)**:
   - не обязательно графический график, но:
     - список ключевых событий: "Start", "Epoch 1/10", "Epoch 5/10", "Done", "Error …";
   - ссылка на полные логи (Flow History / файлы).

5. **Actions**:
   - "Запустить обучение" / "Повторить обучение";
   - "Открыть History";
   - "Перейти к FlowRun", если запуск из Flows.

### 2.3. Поведение при перезапуске приложения

Сценарии:

1. Приложение закрыли во время `running`, потом открыли:
   - TrainingPanel должен:
     - восстановить `last_training_id` (из локального хранилища / последнего snapshot);
     - попытаться получить актуальный Snapshot для этого id;
     - показать:
       - либо актуальный статус (если backend знает, что с этим run),
       - либо "состояние неизвестно, предполагаем, что обучение не продолжается" — но явно.

2. Приложение открыто, но training уже завершён давно:
   - TrainingPanel может показывать последний `done`/`error` запуск и кнопку "Запустить новый".

---

## 3. FlowsPanel — UX интеграция с PULSE v2

### 3.1. Карточка FlowRun

Для каждого запуска flow (`FlowRun`) в истории должно быть видно:

- `flow_name` и `started_at`;
- общий статус FlowRun (успех/ошибка/частичный успех);
- длительность FlowRun;
- количество шагов и их статусы.

Для TRAIN-шагов:

- иконка/метка, показывающая, что внутри был TrainingRun;
- краткий итог:
  - "Training: done (10 epochs, best loss 0.34)",
  - или "Training: error (CUDA OOM)".

### 3.2. Детализация TRAIN шага

При открытии деталей конкретного TRAIN шага:

- показывается "вложенный" TrainingPanel:
  - те же зоны, что у обычного TrainingPanel,
  - но в контексте конкретного FlowRun & step.

Требование:
- FlowsPanel не должен дублировать сложную логику TrainingPanel;
- скорее он использует те же данные/компонент в "read-only/readonly-history" режиме.

### 3.3. Связь Flow History ↔ Training History

Важно, чтобы пользователь:

- мог зайти в историю flows,
- найти нужный FlowRun,
- кликнуть по TRAIN шагу,
- и увидеть **то же самое состояние тренировки**, что он видел бы в TrainingPanel (только с "прошедшим временем").

---

## 4. UX сценарии и edge cases

### 4.1. Несколько запусков подряд

Сценарий:

1. Пользователь запускает обучение вручную (TrainingPanel).
2. После завершения — меняет параметры и запускает ещё раз.
3. Параллельно у него могут быть Flows, которые тоже запускают TRAIN.

Требования:

- TrainingPanel:
  - по умолчанию показывает **последний запуск** (по времени), но:
    - должен иметь доступ к списку недавних TrainingRun (history);
- Flows:
  - каждый FlowRun привязан к своему `training_id`; путаницы быть не должно.

### 4.2. Ошибка "изнутри" Flow

Если TRAIN внутри FlowRun упал с ошибкой:

- в Flows History:
  - FlowRun должен помечаться как `error` или `partial_error`;
  - конкретный шаг TRAIN — с понятным кратким описанием ошибки;
- при клике:
  - пользователь должен понять:
    - что за ошибка,
    - на каком этапе TRAIN она случилась,
    - можно ли её повторить (retry) вручную.

### 4.3. Нет данных / потеря контекста

Если:

- события PULSE v2 по какой-то причине не приходят,
- или локальный контекст `training_id` не совпадает с тем, что знает backend,

то TrainingPanel должен:

- честно сказать "Контекст обучения потерян / неизвестен",
- предложить:
  - запустить новое обучение,
  - или открыть Flow History, если это часть flow.

---

## 5. Клиентская модель данных (без привязки к фреймворку)

На уровне UI логично иметь два основных "слоя" данных:

### 5.1. TrainingState

Объект, описывающий текущий/последний TrainingRun:

- `current_training_id: string | null`
- `snapshot: TrainingSnapshot | null`
- `timeline: TrainingEvent[]` (обрезанный до разумного размера)
- `recent_trainings: TrainingRunSummary[]` (история по времени)

### 5.2. FlowState (уже есть частично)

Расширяется тем, что:

- каждый TRAIN шаг в `FlowRun` может иметь:
  - `training_id`,
  - короткий summary.

Требование:

- TrainingState и FlowState **развиваются как слои, использующие один и тот же PULSE v2 протокол**, а не дублируют логику друг друга.

---

## 6. UX-правила для отображения событий PULSE v2

1. **Не спамить UI:**
   - UI обновляет прогресс визуально не чаще, чем X раз в секунду (конкретное X — в техспеке/коде).
   - Если приходят частые события, они могут агрегироваться/пропускаться на UI-уровне.

2. **Последовательность важнее "каждого события":**
   - Если событие пришло с устаревшим timestamp (меньше, чем уже отображённый), UI может его игнорировать.

3. **Ошибки всегда "перебивают" прогресс:**
   - если приходит error-событие для активного `training_id`, статус сразу меняется на `error`, даже если следом придут устаревшие "running".

4. **Состояние `done` — терминальное:**
   - после `done` для данного `training_id` никаких новых progress/metric событий не должно менять статус;
   - если приходят — UI имеет право их игнорировать или считать инконсистентными.

---

## 7. Что НЕ входит в этот документ

- Конкретные форматы JSON событий (см. PULSE_V2_TECH_SPEC.md).
- Реализация event-канала (file watcher, Tauri events, WebSocket и др.).
- Конкретные имена полей в коде (типы/интерфейсы на Rust/TS уровне).

Этот документ описывает **логический UX-слой и информационную архитектуру**, на которой потом будет строиться техническая спецификация и реализация.

---
