Аудит Системных Рисков: Интеграция userfaultfd с VRAM NVIDIA (R550+) в Средах KVM/HMM




Раздел 1. Анализ Совместимости userfaultfd с VRAM на базе NVIDIA Open Kernel Modules (R550+) (Проверка Риска 1)




1.1. Теоретическая основа: userfaultfd и HMM (Heterogeneous Memory Management)


Для верификации Риска 1 необходимо сначала установить теоретическую базу взаимодействия между userfaultfd, HMM и драйверами NVIDIA. Механизм userfaultfd в ядре Linux представляет собой системный вызов, позволяющий процессу в пространстве пользователя (user-space) перехватывать и обрабатывать ошибки страниц ($page$ $faults$) для выделенных ему областей виртуальной памяти. В контексте виртуализации, QEMU использует userfaultfd для отслеживания доступа гостевой ОС к памяти, что является критически важным для реализации "живой" миграции.
Технология HMM (Heterogeneous Memory Management), в свою очередь, является ключевым компонентом ядра, разработанным для интеграции памяти устройств (такой как VRAM) в общее адресное пространство CPU. HMM позволяет ядру создавать дескрипторы struct page для памяти устройства, эффективно "маскируя" VRAM под обычную системную RAM. Это позволяет стандартным подсистемам ядра, таким как userfaultfd, оперировать этой памятью.
Документация самой NVIDIA по HMM подтверждает эту теоретическую синергию. В ней указывается, что HMM обеспечивает прозрачное отображение памяти GPU в адресное пространство процесса CPU, и что механизм userfaultfd может быть использован для перехвата ошибок страниц CPU на этой памяти. Это, в свою Lочередь, позволяет инициировать миграцию данных "по требованию" (on-demand) между CPU и GPU.
Исходя из этой теоретической модели, архитектура, в которой QEMU использует userfaultfd для управления HMM-отображенной VRAM с целью отслеживания "грязных" страниц для живой миграции, выглядит не только жизнеспособной, но и канонической. Следовательно, ioctl(UFFDIO_REGISTER) должен успешно регистрировать обработчик userfaultfd на диапазоне VRAM.


1.2. Практическая реальность: Блокировки на уровне драйвера nvidia-uvm


Несмотря на теоретическую жизнеспособность, практические данные указывают на прямое противоречие. Существуют многочисленные свидетельства того, что попытка регистрации userfaultfd на VRAM, управляемой драйверами NVIDIA, приводит к немедленной ошибке.
Ключевой симптом — это возврат ошибки EPERM (Operation not permitted) при вызове ioctl(UFFDIO_REGISTER) на VRAM. В отчетах об ошибках, точно воспроизводящих сценарий PoC, разработчики (вероятно, работающие над интеграцией QEMU или аналогичных систем) сообщают о систематическом сбое. Попытка mmap'инга VRAM через драйвер UVM (Unified Virtual Memory) и последующая регистрация userfaultfd на этом диапазоне завершается с ошибкой userfaultfd register ioctl failed: Operation not permitted.
Это доказывает, что Риск 1 не гипотетический, а является реальным и активным блокировщиком.
