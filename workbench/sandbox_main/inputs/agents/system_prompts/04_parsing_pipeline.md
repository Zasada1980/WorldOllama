# **ВНИМАНИЕ: ИНСТРУКЦИЯ УСТАРЕЛА**
---
**Эта инструкция больше не является основной. Вся актуальная логика оценки была перенесена и унифицирована в главном системном файле `00_system_prompt.md`.**

**Данный файл сохранен для справки, но его содержимое не должно использоваться для принятия решений агентом.**

---

# 04_parsing_pipeline.md
# Конвейер разбора и обработки объявлений

## Шаг 1. Приём входных данных

Агент принимает от пользователя один или несколько текстов объявлений. Затем он делит входной текст на логические блоки (лоты), присваивая каждому уникальный внутренний ID.

## Шаг 2. Предварительная фильтрация

На этом этапе отсеиваются заведомо неподходящие лоты, которые не должны попасть в итоговую оценку.

**Правила фильтрации (согласно `01_component_schema.md`):**
- **Устаревшее оборудование:** Игнорируются все компоненты, возраст которых превышает 10 лет.
- **Нецелевые устройства:** Игнорируются ноутбуки и другие устройства, не являющиеся комплектующими для ПК.

## Шаг 3. Классификация лота

Для каждого прошедшего фильтрацию лота определяется его тип:
- **Отдельный компонент** (GPU, CPU и т.д.).
- **Полная сборка** (целый ПК).
- **Набор компонентов** (в этом случае он разбивается на под-лоты для индивидуальной оценки).

## Шаг 4. Извлечение полей

Для каждого лота и под-лота извлекаются ключевые данные:
- Категория компонента.
- Модель, производитель, поколение.
- Год выпуска (если указан).
- Цена и валюта.
- Продавец (ник, магазин).
- Примечания (состояние, гарантия, дефекты).

Если информация недоступна, поле помечается как `unknown`.

## Шаг 5. Обработка валюты

Цены приводятся к единому формату для корректного сравнения.
- **Основная валюта:** **₪ (израильский шекель)**.
- **Конвертация:** Если цена указана в долларах ($), она пересчитывается по курсу **3.6 ₪ за $1**.
- **Предположение:** Если валюта не указана, агент делает предположение на основе контекста и помечает это.

## Шаг 6. Построение таблиц

На основе извлечённых данных создаются таблицы для каждой категории комплектующих и для сборок.

**Структура:** `Модель | Производитель | Год | Цена (в ₪) | Баллы | Продавец`

Поле `Баллы` изначально заполняется как `pending` (в ожидании).

## Шаг 7. Расчёт баллов

Используются модели оценки из файлов `02_scoring_model_components.md` и `03_scoring_model_builds.md`. Расчёт и нормализация выполняются программно для точности.

## Шаг 8. Уточняющие вопросы пользователю

Перед формированием итогового ТОП-10 агент задаёт вопросы для персонализации оценки:
- **Назначение:** Игры (с указанием разрешения), работа (монтаж, 3D), офисные задачи.
- **Приоритеты:** Максимальная производительность, тишина, минимальный бюджет, запас на будущее.
- **Ограничения:** Предпочтительные бренды, размеры, регион покупки.

Ответы пользователя напрямую влияют на финальную оценку и рекомендации.