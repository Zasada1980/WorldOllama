Разрешение Архитектурного Тупика: Окончательный Анализ DDA в Windows 11 Pro против SOTA-Статуса WSL2 (Ноябрь 2025 г.)




Введение


При развертывании высокопроизводительных вычислений (HPC) и сред машинного обучения (ML) на рабочих станциях под управлением Windows 11 Pro, системные архитекторы сталкиваются с критическим выбором архитектуры. Этот выбор часто сводится к двум фундаментально различным путям: (1) использование прямого назначения устройств (DDA) через Hyper-V для предоставления гостевой виртуальной машине (ВМ) эксклюзивного доступа к GPU (например, NVIDIA RTX 4090 или RTX 5060) и (2) использование Windows Subsystem for Linux 2 (WSL2) для запуска Linux-нагрузок (например, $vLLM$) с использованием виртуализированного доступа к GPU.
Оба пути исторически страдали от серьезных недостатков, которые ставили под угрозу их жизнеспособность для production-нагрузок. Путь DDA на клиентских ОС, казалось, был заблокирован, в то время как WSL2 страдал от компромиссов в производительности и стабильности.
Цель данного отчета — предоставить окончательный, технически исчерпывающий вердикт по обоим путям, основанный на анализе официальной документации, технических отчетов об ошибках и отраслевых обсуждениях по состоянию на ноябрь 2025 года. Этот анализ разрешит существующий архитектурный тупик, предоставив четкие, основанные на фактах рекомендации.
Отчет структурирован следующим образом:
* Часть 1 выносит окончательный вердикт о жизнеспособности DDA в Windows 11 Pro, анализируя предполагаемое отсутствие командлетов (таких как $Dismount-VmGpu$) и исследуя фундаментальные ограничения на уровне операционной системы.
* Часть 2 проводит глубокий SOTA-анализ (State-of-the-Art) четырех ключевых проблемных областей в WSL2: стабильность $vLLM$, поддержка $pinned$ $memory$, поддержка $NVLink$ и поддержка $CRIU$ (Checkpoint/Restore).
* Часть 3 предоставляет сводное заключение и стратегические рекомендации для принятия окончательного архитектурного решения.
________________


Часть 1: Окончательный Вердикт по DDA (Discrete Device Assignment) в Windows 11 Pro




1.1 Анализ Недоступности Командлета: $Dismount-VmGpu$ против $Dismount-VMHostAssignableDevice$


Первоначальная проблема, связанная с отсутствием командлета $Dismount-VmGpu$ в Windows 11 Pro, основана на фундаментальном недоразумении, смешивающем две различные технологии виртуализации GPU от Microsoft. Устранение этой путаницы является первым шагом к пониманию истинного барьера.
Технология GPU Partitioning (GPU-P) и семейство $VMGpuPartitionAdapter$
Командлет $Dismount-VmGpu$ (или его логический эквивалент) относится к технологическому стеку, известному как GPU Partitioning (GPU-P). Это новая возможность, представленная в Windows Server 2025.1
GPU-P не обеспечивает "проброс" всего устройства. Вместо этого он использует интерфейс Single Root I/O Virtualization (SR-IOV) для разделения (партиционирования) одного физического GPU на несколько "изолированных долей", которые могут быть назначены разным виртуальным машинам.3 Этот подход позволяет нескольким ВМ совместно использовать один GPU, при этом каждая ВМ получает выделенную часть ресурсов.3
Командлеты PowerShell, связанные с этой технологией, включают:
* Add-VMGpuPartitionAdapter 4
* Get-VMGpuPartitionAdapter 5
* Remove-VMGpuPartitionAdapter 5
Следовательно, отсутствие $Dismount-VmGpu$ не является симптомом сбоя DDA; это просто означает, что технология GPU-P (которая является функцией Windows Server 2025) не применяется или не установлена.
Технология Discrete Device Assignment (DDA) и семейство $VMHostAssignableDevice$
Discrete Device Assignment (DDA) — это совершенно другая технология. Она позволяет полностью "пробросить" физическое устройство PCIe (например, GPU или NVMe-накопитель) напрямую в гостевую ВМ.6 ВМ получает эксклюзивный контроль над устройством и может использовать его "родные" драйверы, обеспечивая производительность, близкую к "bare-metal".6
Правильная последовательность командлетов PowerShell для DDA выглядит следующим образом 4:
1. Отключение устройства на хосте: Устройство должно быть отключено в Диспетчере устройств хоста или через PowerShell (например, с помощью Disable-PnpDevice).6
2. Отсоединение устройства от хоста: Используется командлет $Dismount-VMHostAssignableDevice$.7
3. Назначение устройства гостю: Используется командлет $Add-VMAssignableDevice$.7
Таким образом, "тупик" не связан с отсутствующим командлетом. Правильный командлет для DDA — $Dismount-VMHostAssignableDevice$ — существует в модуле Hyper-V.9 Реальная проблема заключается в том, почему выполнение этого командлета и всего процесса DDA завершается неудачей в Windows 11 Pro.


1.2 Фундаментальное Ограничение SKU: Почему DDA Заблокирован в Windows 11 Pro


Анализ показывает, что DDA не является функцией Windows 11 Pro. Это преднамеренное, неразрешимое ограничение на уровне SKU (Stock Keeping Unit) и гипервизора, а не ошибка PowerShell 7 или отсутствие модуля.
Прямые Доказательства из Документации Microsoft
Официальная документация Microsoft является окончательным источником по этому вопросу. Руководство по устранению неполадок с GPU в Hyper-V (обновлено для Windows 11 и Windows Server 2025) содержит недвусмысленное заявление:
"DDA and GPU-P aren't supported on desktop-class hardware or client operating systems such as Windows 10 or 11 Pro".11
Это заявление категорично. Более того, все официальные руководства по развертыванию DDA 6 в разделе "Prerequisites" (Необходимые условия) указывают: "A Hyper-V host running Windows Server 2016 or later." Windows 11 Pro никогда не упоминается в качестве поддерживаемой хост-ОС.
Анализ Сообщений о Сбоях и Отчетов Сообщества
Отчеты разработчиков и системных администраторов подтверждают, что это не просто отсутствие документации, а жесткая техническая блокировка.
* В обсуждениях, посвященных DDA, ответ на вопрос о его работе в Windows 11 Pro однозначен: "DDA is only supported on hosts running Server SKUs" (DDA поддерживается только на хостах с серверными SKU).12 Другой опытный пользователь подтверждает: "DDA is not supported in client Windows versions. This is for Windows Server only" (DDA не поддерживается в клиентских версиях Windows. Это только для Windows Server).10
* Наиболее важным является тип ошибки, с которой сталкиваются пользователи при попытке принудительно выполнить DDA. Ошибка — это не "cmdlet not found" (что указывало бы на проблему PowerShell) 13, а "a hypervisor feature is not available to the user" (функция гипервизора недоступна пользователю).14
* Другие связанные сбои, такие как "Virtual PCI Express Port failed to power on" (Виртуальный порт PCI Express не удалось включить) 15, также указывают на то, что базовый гипервизор Windows 11 Pro активно отклоняет запрос на назначение устройства.
Деконструкция Альтернативных Гипотез
* "Это ограничение PowerShell 7?" Нет. Хотя существуют некоторые проблемы совместимости старых модулей (например, VirtualMachineManager) с PowerShell 7 16, основной модуль Hyper-V является встроенным и совместимым. Ошибка "feature is not available" 14 доказывает, что проблема находится на уровне гипервизора, а не оболочки.
* "Это ограничение SKU?" Да. Это корень проблемы. Блокировка DDA в Windows 11 Pro — это бизнес-решение, реализованное в виде технической блокировки. Microsoft стратегически сегментирует свой рынок, резервируя DDA и GPU-P для своих высокодоходных платформ Windows Server 2 и Azure Stack HCI.2 Включение этих функций в клиентской ОС привело бы к каннибализации продаж серверных лицензий, позволив создавать мощные серверные среды на базе дешевых клиентских ОС.
Этот барьер не может быть обойден с помощью редактирования реестра или установки другого модуля PowerShell. Он требует замены операционной системы хоста на Windows Server SKU.


1.3 Оценка Обходных Путей и Поддержки Оборудования (RTX 4090/5060)


Анализ не был бы полным без рассмотрения следующего шага: что произойдет, если заменить ОС на Windows Server 2022 или 2025 для использования DDA с оборудованием (RTX 4090)? Здесь возникает второй, менее очевидный, но столь же критический барьер.
Проблемы с Потребительскими GPU на Серверных SKU
Даже на поддерживаемой серверной ОС использование потребительских GPU (серии GeForce/RTX) для DDA сопряжено с трудностями:
1. Блокировка Вендором (Историческая): Официальная документация Microsoft предупреждает, что "некоторые вендоры предотвращают работу своих потребительских карт при пробросе в ВМ".6 Хотя NVIDIA в значительной степени ослабила эту политику для потребительских карт, устранив печально известную "Code 43" 14, этот риск всегда следует учитывать.
2. Проблема MMIO >16 ГБ (Критично для RTX 4090): RTX 4090 имеет 24 ГБ VRAM. Это создает специфическую техническую проблему. Официальные отчеты об ошибках NVIDIA 17 и обсуждения на форумах разработчиков 18 подтверждают, что DDA завершается неудачей для GPU с объемом памяти более 16 ГБ.
   * Симптом: После успешного выполнения команд DDA гостевая ОС (например, Debian 12) не обнаруживает GPU.18
   * Причина: Таким GPU требуется значительно большее адресное пространство MMIO (Memory-Mapped Input/Output) для корректного отображения в гостевой ВМ.
   * Решение: Это требует дополнительной, неочевидной настройки ВМ для резервирования большего пространства MMIO. Это делается с помощью командлета Set-VM, например: $Set-VM$ -$VMName$ $YourVMName$ -$LowMemoryMappedIoSpace$ $1Gb$ -$HighMemoryMappedIoSpace$ $32Gb$.4
Таким образом, путь DDA заблокирован "двойной стеной". Первая стена — это жесткая, непреодолимая SKU-блокировка (Pro против Server) от Microsoft.11 Вторая стена (для RTX 4090/5060) — это высокий технический барьер (настройка MMIO), требующий экспертных знаний, даже после установки правильной ОС.17


1.4 Вердикт по Пути 1 (DDA)


Путь 1 (DDA на Windows 11 Pro) является окончательным техническим тупиком.
1. Командлет $Dismount-VmGpu$, который искал пользователь, не имеет отношения к DDA. Он является частью стека GPU-P, эксклюзивного для Windows Server 2025.1
2. Правильная технология DDA ($Dismount-VMHostAssignableDevice$, $Add-VMAssignableDevice$) 7 существует.
3. Однако базовый гипервизор Windows 11 Pro преднамеренно блокирует эту функцию.11 Это неразрешимое ограничение SKU, являющееся бизнес-решением Microsoft.
4. Даже при обновлении хоста до Windows Server 2025, выбранное оборудование (RTX 4090 с VRAM > 16 ГБ) потребует сложной, неочевидной настройки MMIO для функционирования.17
Рекомендация: Следует немедленно отказаться от дальнейших попыток реализации DDA в Windows 11 Pro.
________________


Часть 2: SOTA-Анализ Стабильности и Производительности WSL2 (Ноябрь 2025 г.)


Признав, что DDA является тупиком, анализ переходит к Пути 2. Необходимо оценить, остается ли WSL2 компромиссным решением для разработки или же последние обновления 2025 года (включая драйверы NVIDIA 570/580) устранили четыре критических недостатка, препятствующих его использованию в production.


2.1 Стабильность vLLM: Режим Сна ($Sleep Mode$) и Параллелизм Данных ($Data Parallel$)


Опасения относительно стабильности $vLLM$ в сложных сценариях полностью оправданы. Анализ отчетов об ошибках по состоянию на ноябрь 2025 года показывает, что функция $Sleep$ $Mode$ (Режим сна) является нестабильной и сопряжена с высоким риском, особенно при использовании с распараллеливанием данных ($data$ $parallel$).
Контекст: $Sleep$ $Mode$ 19 — это ключевая функция $vLLM$ для эффективного обслуживания нескольких моделей. Она позволяет выгружать веса модели в ОЗУ хоста (Level 1) или полностью отбрасывать их (Level 2), освобождая драгоценную VRAM для других задач.21
Анализ Конкретных Сбоев (Ноябрь 2025 г.):
1. Проблема 1: Сбой при запросе к спящей модели (Issue #15483)
   * Симптом: Сервер $vLLM$ аварийно завершает работу с ошибкой CUDA "an illegal memory access was encountered" (обнаружен недопустимый доступ к памяти), если к нему поступает API-запрос (например, $v1/completions$) в то время, как модель находится в режиме сна.22 Ожидаемое поведение — автоматическое "пробуждение" или возврат HTTP-ошибки (например, 503) — не происходит.
   * Статус (Ноябрь 2025): НЕ РЕШЕНО. Отчет об ошибке 22 подтверждает, что Issue #15483 "Open" (Открыт) и помечен как "stale" (устаревший). Хотя был предложен Pull Request (PR #16536) для исправления этого 22, он, очевидно, не был принят или не решил проблему полностью.
2. Проблема 2: Сбой $Sleep$ $Mode$ при $Data$ $Parallel$ (Issue #24879)
   * Симптом: Этот отчет напрямую касается запрашиваемого сценария. Вызов $engine.sleep()$ сразу после "rollout" (типичный шаг в Reinforcement Learning from Human Feedback, RLHF) в конфигурации с распараллеливанием данных (DP) приводит к немедленному сбою движка $vLLM$.23
   * Статус (Ноябрь 2025): НЕ РЕШЕНО. Issue #24879 23 остается открытым.
3. Проблема 3: "Fatal Python error: none_dealloc" (Issue #16993)
   * Симптом: Частые вызовы $engine.sleep$ (например, в цикле RL) приводили к фатальной ошибке Python и Segmentation Fault.24 Проблема была связана со сложным взаимодействием между сборщиком мусора Python (GC), пользовательским управлением памятью $vLLM$ и $CUDAPluggableAllocator$ PyTorch.24
   * Статус (Ноябрь 2025): ВЕРОЯТНО РЕШЕНО. Это единственная положительная новость. Сообщения от мейнтейнеров $vLLM$ в октябре 2025 года 24 указывают, что эта проблема "should be fixed by" PR #23477.
Вердикт по разделу: Статус $Sleep$ $Mode$ в $vLLM$ на ноябрь 2025 года — "нестабильная бета-версия". Хотя одна из трех основных причин сбоев (конфликт с GC) была недавно устранена 24, две другие, включая ту, что напрямую связана со стеком $data$ $parallel$ (Issue #24879) 23, остаются открытыми. Использование $Sleep$ $Mode$ в production-среде, особенно с $data$ $parallel$, сопряжено с высоким риском и приведет к непредсказуемым сбоям. Важно отметить, что эта проблема связана с $vLLM$, а не с WSL2, но она напрямую влияет на жизнеспособность Пути 2.


2.2 «Корень Зла»: Проблема Pinned Memory в WSL2


Оценка этой проблемы подтверждает, что это фундаментальное, подтвержденное и нерешенное архитектурное ограничение WSL2. Драйверы NVIDIA 570/580 не устранили эту проблему.
Техническое Обоснование "Корня Зла"
* Что такое Pinned Memory? $Pinned$ (или page-locked) $memory$ — это область физической RAM хоста, выделенная с помощью $cudaHostAlloc$, которую операционная система не имеет права выгружать в swap-файл на диске.25
* Почему это критично? GPU не может выполнять прямой доступ к памяти (DMA) из обычной, страничной (pageable) памяти. Для асинхронной передачи данных (например, $cudaMemcpyAsync$), которая является основой эффективных конвейеров данных (data pipelines) в ML, память хоста обязательно должна быть $pinned$.25
* Что происходит в WSL2? Без $pinned$ $memory$ драйвер CUDA вынужден прибегать к обходному пути: он сначала синхронно копирует данные из страничной (pageable) памяти в промежуточный $pinned$ буфер (управляемый драйвером), и только затем инициирует асинхронную DMA-передачу на GPU.25 Эта дополнительная операция копирования и синхронизация полностью разрушают конвейер, убивают производительность и создают "бутылочное горлышко" на CPU.
Доказательства Ограничения и Статус Решения (Ноябрь 2025 г.)
1. Официальная Документация NVIDIA: "CUDA on WSL User Guide" (последнее обновление — октябрь 2025 г.) в разделе "Known Limitations" (Известные ограничения) по-прежнему указывает: "Pinned system memory... availability for applications is limited".26
2. Исходный Код Фреймворков: Исходный код $vLLM$ 27 и PyTorch содержит явную проверку: if$ $in_wsl():. Если код выполняется в WSL2, он принудительно устанавливает $pin_memory=False$ и выводит предупреждение: "Using 'pin_memory=False' as WSL is detected. This may slow down the performance".27
3. Отчеты Сообщества: Пользователи сообщают, что принудительная установка $pin_memory=True$ в WSL2 приводит к ошибкам нехватки памяти (OOM) или сбоям.28
4. Статус Драйверов 570/580: Анализ обсуждений драйверов NVIDIA 570/580 в 2025 году 30 показывает, что инженерные усилия были сосредоточены на решении проблем с зависимостями в Ubuntu 24 32 и добавлении поддержки для GPU в режиме MCDM (Microsoft Compute Driver Model), например, Tesla.31 Ни одно из этих обсуждений не упоминает об исправлении или улучшении поддержки $pinned$ $memory$.
Архитектурный Корень Проблемы
Это не "ошибка", которую можно исправить драйвером. Это архитектурный конфликт.33 WSL2 предоставляет CUDA через модель драйвера Windows Display Driver Model (WDDM).26 WDDM — это виртуализированный интерфейс, предназначенный для совместного использования GPU между Windows (для DirectX) и WSL2 (для CUDA). Этот уровень виртуализации по своей природе не позволяет гостевой Linux-системе получить низкоуровневый, эксклюзивный контроль над физической памятью хоста, необходимый для надежной блокировки страниц ($pinning$). Это постоянный налог на производительность, который является ценой за использование WSL2.


2.3 Поддержка Multi-GPU: Статус NVLink


Ключевой Вывод: $NVLink$ не поддерживается в WSL2. Любая меж-GPU коммуникация в multi-GPU конфигурации будет ограничена значительно более медленной шиной PCIe.
Доказательства Отсутствия Поддержки
1. Отсутствие в Документации: Обширные и обновленные (сентябрь/октябрь 2025 г.) руководства от NVIDIA и Microsoft по CUDA on WSL 35 ни разу не упоминают $NVLink$. Это вопиющее упущение для функции, которая является центральной для multi-GPU вычислений.
2. Отчеты о Сбоях (NCCL): Пользователи, пытающиеся выполнять распределенное обучение на WSL2, сообщают о "постоянных проблемах с NCCL".37 NCCL (NVIDIA Collective Communications Library) — это библиотека, которая автоматически использует $NVLink$ для P2P-связи, если он доступен.
3. "Дымящийся пистолет" (Nsight Profiler): Отчет об ошибке из Nsight Profiler (инструмент NVIDIA для профилирования) при работе в WSL2 в мае 2025 года содержит решающее доказательство: "Unified Memory cannot be traced on devices that don't support peer-to-peer transfers. Please verify that SLI/NVLink is functioning properly".38
Архитектурный Корень Проблемы (Единая Теория)
Ошибка Nsight 38 раскрывает корень проблемы: WDDM-драйвер WSL2 26 не предоставляет гостевой системе возможности P2P (peer-to-peer) transfer (прямой передачи данных между устройствами). Без P2P-доступа $NVLink$ не может быть активирован.
Это усугубляет проблему $pinned$ $memory$. Это означает, что multi-GPU установка (например, 2x RTX 4090) в WSL2 будет неэффективной для задач, требующих интенсивного обмена данными (например, тензорный параллелизм в $vLLM$). Карты будут вынуждены общаться через CPU и шину PCIe, что на порядки медленнее, чем прямая связь по $NVLink$, сводя на нет основное преимущество использования высокопроизводительных карт.


2.4 Поддержка Checkpoint/Restore: Статус CRIU и $cuda-checkpoint$


Ключевой Вывод: Поддержка $CRIU$ и $cuda-checkpoint$ в WSL2 отсутствует "из коробки" и, вероятно, архитектурно невозможна без неподдерживаемых, глубоких модификаций ядра.
Анализ $CRIU$ (Track 3)
* Проблема: $CRIU$ (Checkpoint/Restore In Userspace) 39 — это инструмент Linux, который требует глубокой поддержки на уровне ядра для "заморозки" и "восстановления" работающих процессов. Эта поддержка включается флагом CONFIG_CHECKPOINT_RESTORE при компиляции ядра.
* Ядро WSL2: WSL2 использует кастомное ядро, поддерживаемое Microsoft (форк Linux).40 Несмотря на то, что оно основано на современных версиях 6.x 43, оно скомпилировано с минимально необходимым набором функций.
* Статус: Флаг CONFIG_CHECKPOINT_RESTORE не включен в ядре WSL2 по умолчанию.44 Пользователи, пытающиеся установить $CRIU$ в WSL2, сообщают об ошибках, указывающих на отсутствие необходимых компонентов ядра, таких как /proc/[pid]/map_files.46
* Обходной путь: Единственный известный обходной путь — это вручную загрузить исходный код ядра Microsoft 41, вручную отредактировать файл .config$, чтобы включить CONFIG_CHECKPOINT_RESTORE 44, и вручную скомпилировать собственное ядро. Это хрупкий, сложный и полностью неподдерживаемый процесс.
Анализ $cuda-checkpoint$
* Проблема: $cuda-checkpoint$ (способность $CRIU$ сохранять и восстанавливать состояние VRAM) — это следующий уровень сложности. Он требует не только рабочего $CRIU$, но и API-интерфейсов в драйвере CUDA (например, `$cuCheckpointProcessLock$ 26) для координации "заморозки" состояния GPU.
* Статус: Нет абсолютно никаких доказательств того, что WDDM-драйвер NVIDIA 36 предоставляет эти API-перехватчики в гостевую систему WSL2. Вся документация по драйверам (R495+, R510+) 26 фокусируется на базовых вычислениях и IPC (Inter-Process Communication), но не на функциях checkpointing.
Как и в случае с $pinned$ $memory$ и $NVLink$, WDDM-архитектура WSL2 по своей сути не предназначена для предоставления такого низкоуровневого контроля над состоянием процесса GPU.
________________


Часть 3: Заключение и Рекомендации по Разрешению Тупика




3.1 Сводный Анализ Жизнеспособности (Ноябрь 2025 г.)


Анализ разрешает "тупик", демонстрируя, что оба пути в их первоначальной формулировке (DDA на Windows 11 Pro и WSL2 без компромиссов) нежизнеспособны. DDA — это жесткая, непреодолимая стена. WSL2 — это функциональное, но глубоко компромиссное решение.
Следующая таблица суммирует окончательный вердикт по состоянию на ноябрь 2025 года.
Таблица 3.1: Сводная Таблица Анализа Архитектур (Ноябрь 2025 г.)


Критерий
	Путь 1: DDA на Windows 11 Pro
	Путь 2: WSL2 на Windows 11 Pro
	Анализ / Обоснование (SOTA Ноябрь 2025)
	Официальная Поддержка
	НЕТ
	ДА
	DDA категорически не поддерживается в клиентских SKU.11 WSL2 — это флагманская функция.35
	Простота Настройки
	ТУПИК
	СРЕДНЯЯ
	DDA на Pro невозможен. WSL2 требует установки драйверов 36, но в целом прост.
	Стабильность $vLLM$
	Н/Д
	НИЗКАЯ (РИСК)
	Проблемы $vLLM$ $Sleep$ $Mode$ + $Data$ $Parallel$ (Issue #24879) и "запрос во сне" (Issue #15483) остаются открытыми.23
	Производительность (Pinned Memory)
	Н/Д (Теоретически: Отлично)
	НИЗКАЯ (КОМПРОМИСС)
	Фундаментальное ограничение WDDM/WSL2.26 Требуется $pin_memory=False$ 27, что снижает производительность.25
	Поддержка Multi-GPU (NVLink)
	Н/Д (Теоретически: Отлично)
	НЕТ
	Архитектура WDDM не поддерживает P2P-передачи, необходимые для $NVLink$.38 Связь только через PCIe.37
	Поддержка Checkpoint (CRIU)
	Н/Д (Теоретически: Да)
	НЕТ
	Требуется ручная компиляция ядра (для CONFIG_CHECKPOINT_RESTORE).41 Поддержка $cuda-checkpoint$ отсутствует в драйвере WDDM.26
	ОБЩИЙ ВЕРДИКТ
	ТЕХНИЧЕСКИЙ ТУПИК
	АРХИТЕКТУРНЫЙ КОМПРОМИСС
	DDA на Pro невозможен. WSL2 работает, но с серьезными, неисправимыми компромиссами в производительности, стабильности и функциональности.
	

3.2 Синтез и Стратегические Рекомендации


Первоначальный "тупик" основан на ложной дилемме.
* Путь 1 (DDA на Windows 11 Pro) мертв. Это бизнес-блокировка на уровне SKU.11 Дальнейшие усилия в этом направлении бесплодны.
* Путь 2 (WSL2) жизнеспособен, но является глубоким компромиссом. Он не может (и никогда не сможет, из-за архитектуры WDDM) обеспечить ту же производительность 26 и функциональность 38, что и "bare-metal" Linux.
Оценка рисков WSL2 для конкретных запрашиваемых технологий (Ноябрь 2025 г.):
* Риск $vLLM$: Высокий. Конкретный сценарий ($data$ $parallel$ + $sleep$) сломан в $vLLM$ (Issue #24879).23
* Риск $Pinned$ $Memory$: Гарантированный. Это не риск, а постоянный потолок производительности, который необходимо принять.26
* Риск $NVLink$ / $CRIU$: Гарантированный. Эти функции не поддерживаются.38
Это приводит к трем четким стратегическим вариантам разрешения тупика:
Вариант 1: Принятие Компромисса (WSL2)
* Действие: Использовать WSL2 в качестве основной среды для ML-разработки.
* Снижение рисков:
   1. Немедленно отключить $Sleep$ $Mode$ в $vLLM$ и перепроектировать рабочий процесс для обработки "холодных" стартов моделей, приняв связанные с этим задержки.
   2. Принять тот факт, что multi-GPU система будет работать на скорости PCIe, а загрузка данных будет ограничена отсутствием $pinned$ $memory$.
   3. Отказаться от любых планов на $cuda-checkpoint$.
* Подходит для: Разработки, прототипирования и задач, не критичных к задержкам и максимальной пропускной способности.
Вариант 2: Обходной Путь DDA (Windows Server 2025)
* Действие: Заменить Windows 11 Pro на Windows Server 2025 на данной рабочей станции.
* Преимущества: Это включит полноценный DDA 6 или, что еще лучше, новую технологию GPU-P.3 Это обеспечит производительность, близкую к "bare-metal", для ВМ (с DDA) или гибкое разделение (с GPU-P).
* Недостатки:
   1. Потребуется лицензия на Windows Server.
   2. Все равно придется вручную решать проблему с MMIO >16 ГБ для RTX 4090.17
   3. Накладные расходы и UX серверной ОС на рабочей станции.
Вариант 3: Решение "Bare-Metal" (Рекомендуется)
* Действие: Признать, что запрашиваемые требования (максимальная производительность $vLLM$, $NVLink$, $pinned$ $memory$, $CRIU$) — это требования нативной Linux-системы.
* Реализация: Установить двойную загрузку (Dual-Boot) Windows 11 Pro (для работы и игр) и Ubuntu 24.04 (для ML).
* Преимущества: Это единственный путь, который удовлетворяет всем техническим требованиям без каких-либо компромиссов. $Pinned$ $memory$ будет работать на полной скорости. $NVLink$ будет работать. $CRIU$ (и $cuda-checkpoint$) можно будет настроить.
* Заключение: Попытка заставить клиентскую ОС (Windows 11 Pro) работать как сервер для HPC (с помощью DDA или WSL2) приводит к столкновению с непреодолимыми архитектурными барьерами. Вместо того чтобы пытаться "взломать" неисправную архитектуру, следует использовать правильный инструмент для работы. Для бескомпромиссных ML-нагрузок этим инструментом является "bare-metal" Linux.
Источники
1. What's new in Windows Server 2025 - Microsoft Learn, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
2. Introducing GPU Innovations with Windows Server 2025 - Microsoft Community Hub, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
3. Partition and share GPUs with virtual machines on Hyper-V - Microsoft Learn, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
4. Hyper-V GPU Passthrough: An Essential Guide for Beginners - NAKIVO, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
5. Remove-VMGpuPartitionAdapter (Hyper-V) | Microsoft Learn, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
6. Deploy graphics devices by using Discrete Device Assignment - Microsoft Learn, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
7. Deploy NVMe Storage Devices using Discrete Device Assignment - Microsoft Learn, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
8. Multiple GPU Assignments to a Single Hyper-V VM with DDA - NVIDIA Developer Forums, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
9. Hyper-V Module | Microsoft Learn, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
10. DDA for VMs (Server 2022 Hyper-V): A Simple Guide : r/HyperV - Reddit, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
11. Troubleshooting guidance for Hyper-V GPU assignment, partitioning, and passthrough - Windows Server | Microsoft Learn, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
12. DDA on windows 11 : r/HyperV - Reddit, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
13. Different ways to mount and unmount VHD/VHDX files - Kernel Data Recovery, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
14. Some ponderings on DDA on Windows 10/11 Pro : r/HyperV - Reddit, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
15. Virtual Pci Express Port Failed to Power on with Error 'A hypervisor feature is not available to the user - Microsoft Learn, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
16. Powershell 7 breaks Virtualmachinemanager (SCVMM) module · Issue #21214 - GitHub, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
17. Microsoft DDA fails with some GPUs - NVIDIA Docs, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
18. NVIDIA L4 GPU Hyper-V - Need Advice/Help, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
19. Zero-Reload Model Switching with vLLM Sleep Mode, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
20. Sleep Mode - vLLM, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
21. Sleep Mode Guide - vllm-ascend - Read the Docs, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
22. [Bug]: vLLM engine crashes then restarts and loads the model on sleep if a chat request is made · Issue #15483 - GitHub, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
23. [Bug]: Crash occurs when calling sleep while running vLLM engine in data parallel mode · Issue #24879 - GitHub, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
24. Deallocating None when using engine.sleep? - General - vLLM ..., дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
25. Why is CUDA pinned memory so fast? - Stack Overflow, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
26. CUDA on WSL User Guide, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
27. WSL performance issue with pin_memory=False · Issue #1084 · vllm-project/vllm - GitHub, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
28. Using pin_memory=true in the WSL2 environment will cause an error #1032 - GitHub, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
29. (WSL2) RuntimeError: CUDA failed with error out of memory · Issue #442 · SYSTRAN/faster-whisper - GitHub, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
30. Getting Started — NVIDIA NIM on WSL2, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
31. Enabling WSL2 on TCC gpu (L4) by switching to MCDM - NVIDIA Developer Forums, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
32. Nvidia-driver-570 installation is broken (again) - Linux, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
33. What are the pinned memory limitations on CUDA for WSL2? - NVIDIA Developer Forums, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
34. Change limit of 50% for cudaHostAlloc pinned memory on Windows 10/11, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
35. CUDA on Windows Subsystem for Linux (WSL) - NVIDIA Developer, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
36. Enable NVIDIA CUDA on WSL 2 - Microsoft Learn, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
37. I have spent 7+ hours trying to get WSL2 to work with Multi-GPU training - is it basically impossible on windows? lol - Reddit, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
38. Nsight system error : Unified Memory cannot be traced on devices that don't support peer-to-peer transfers - NVIDIA Developer Forums, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
39. CRIU, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
40. Using Latest Kernel Linux on WSL 2 - MicroHobby, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
41. The source for the Linux kernel used in Windows Subsystem for Linux 2 (WSL2) - GitHub, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
42. Manual installation steps for older versions of WSL | Microsoft Learn, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
43. How to use the Microsoft Linux kernel v6 on WSL2, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
44. Instructions for using kernel 6.3.y on WSL2 (you probably shouldn't do this) - Reddit, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
45. Recompile your WSL2 kernel - support for snaps, apparmor, lxc, etc. - GitHub Gist, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]
46. Criu on WSL · Issue #2833 · microsoft/WSL - GitHub, дата последнего обращения: ноября 8, 2025, [URL_REMOVED]