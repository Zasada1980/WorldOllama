# –û–¢–ß–Å–¢: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ nest_asyncio –¥–ª—è –†–µ—à–µ–Ω–∏—è Event Loop –ö–æ–Ω—Ñ–ª–∏–∫—Ç–∞

**–î–∞—Ç–∞:** 22.11.2025 ~20:00  
**–°–∏—Å—Ç–µ–º–∞:** AI Librarian Core (LightRAG Server)  
**–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:** AI Agent Deployment System

---

## üìã EXECUTIVE SUMMARY

**–ü–†–û–ë–õ–ï–ú–ê:** `RuntimeError: This event loop is already running` –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ `rag.insert()` –≤—ã–∑–≤–∞—Ç—å `asyncio.run()` –≤–Ω—É—Ç—Ä–∏ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ FastAPI event loop.

**–†–ï–®–ï–ù–ò–ï:** –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ `nest_asyncio.apply()` –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö event loops.

**–°–¢–ê–¢–£–°:** ‚úÖ –ü–∞—Ç—á –ø—Ä–∏–º–µ–Ω—ë–Ω, —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω, –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è.

---

## üîß –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```powershell
pip install nest_asyncio
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ü–∞–∫–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ

### 2. –ü–∞—Ç—á –°–µ—Ä–≤–µ—Ä–∞
**–§–∞–π–ª:** `E:\AI_Librarian_Core\lightrag_server.py`  
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:** –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞ (—Å—Ç—Ä–æ–∫–∏ 1-2):
```python
import nest_asyncio
nest_asyncio.apply()
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–∞—Ç—á asyncio —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ –≤ event loop
- `asyncio.run()` –≤–Ω—É—Ç—Ä–∏ `rag.insert()` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ü–∏–∫–ª FastAPI
- –£—Å—Ç—Ä–∞–Ω—è–µ—Ç `RuntimeError: This event loop is already running`

### 3. –û—á–∏—Å—Ç–∫–∞ –ö—ç—à–∞
```powershell
Remove-Item "E:\AI_Librarian_Core\lightrag_cache\*" -Recurse -Force
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –∫—ç—à–∞ —É–¥–∞–ª–µ–Ω—ã –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 4. –ó–∞–ø—É—Å–∫ –°–µ—Ä–≤–µ—Ä–∞
```powershell
Start-Process powershell -ArgumentList "-NoExit", "-Command", "cd E:\AI_Librarian_Core; python lightrag_server.py"
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –æ–∫–Ω–µ PowerShell (–∏–∑–±–µ–≥–∞–µ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è background –ø—Ä–æ—Ü–µ—Å—Å–∞)

### 5. –¢–µ—Å—Ç–æ–≤—ã–π –ó–∞–ø—Ä–æ—Å
**Endpoint:** `POST http://localhost:8003/insert`  
**Payload:**
```json
{
    "text": "–í–Ω–µ–¥—Ä–µ–Ω–∏–µ nest_asyncio –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –º–µ—Ç–æ–¥–∞–º, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–º asyncio.run, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤–Ω—É—Ç—Ä–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ FastAPI, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –æ—à–∏–±–∫–∏ Event loop already running."
}
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ HTTP –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏–Ω—è–ª

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –§–∞–π–ª—ã (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ ~60 —Å–µ–∫—É–Ω–¥):

| –§–∞–π–ª | –û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------------|------------|
| `graph_chunk_entity_relation.graphml` | >3 –ö–ë | –ì—Ä–∞—Ñ —Å—É—â–Ω–æ—Å—Ç–µ–π –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–π |
| `vdb_entities.json` | >20 –ö–ë | –í–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π |
| `vdb_relationships.json` | >15 –ö–ë | –í–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π |
| `vdb_chunks.json` | >5 –ö–ë | –í–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —á–∞–Ω–∫–æ–≤ |
| `kv_store_llm_response_cache.json` | >10 –ö–ë | –ö—ç—à LLM –æ—Ç–≤–µ—Ç–æ–≤ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –≤—ã–∑–æ–≤—ã –º–æ–¥–µ–ª–∏) |

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –£—Å–ø–µ—Ö–∞:
- ‚úÖ –í—Å–µ 5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ –†–∞–∑–º–µ—Ä—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –æ–∂–∏–¥–∞–Ω–∏—è–º
- ‚úÖ Timestamp —Ñ–∞–π–ª–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—Ä–æ—Å–∞
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞

---

## üîç –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï

### –ü—Ä–æ–±–ª–µ–º–∞ (–î–û –≤–Ω–µ–¥—Ä–µ–Ω–∏—è nest_asyncio)

```
FastAPI Event Loop (Uvicorn) ‚Üê –ì–ª–∞–≤–Ω—ã–π event loop
    ‚Üì
await asyncio.to_thread(rag.insert, text) ‚Üê –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ thread pool
    ‚Üì
rag.insert(text) ‚Üê –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
    ‚Üì
asyncio.run(extract_entities(...)) ‚Üê –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –ù–û–í–´–ô event loop
    ‚Üì
‚ùå RuntimeError: This event loop is already running
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- Python asyncio –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—Ä–µ—â–∞–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ `asyncio.run()` –≤—ã–∑–æ–≤—ã
- `asyncio.to_thread()` –ø–µ—Ä–µ–¥–∞—ë—Ç –≤ thread pool, –Ω–æ event loop –≤—Å—ë –µ—â—ë –∞–∫—Ç–∏–≤–µ–Ω
- Deadlock: –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–∏—Å–∞–µ—Ç –±–µ–∑ —è–≤–Ω–æ–π –æ—à–∏–±–∫–∏

### –†–µ—à–µ–Ω–∏–µ (–ü–û–°–õ–ï nest_asyncio.apply())

```
FastAPI Event Loop (Uvicorn) ‚Üê –ì–ª–∞–≤–Ω—ã–π event loop
    ‚Üì
import nest_asyncio; nest_asyncio.apply() ‚Üê –ü–∞—Ç—á asyncio
    ‚Üì
await asyncio.to_thread(rag.insert, text)
    ‚Üì
rag.insert(text)
    ‚Üì
asyncio.run(extract_entities(...)) ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô event loop
    ‚Üì
‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–µ–∑ –æ—à–∏–±–æ–∫
```

**–ú–µ—Ö–∞–Ω–∏–∑–º:**
- `nest_asyncio` –ø–∞—Ç—á–∏—Ç `asyncio._run_once()` –∏ `asyncio.run()`
- –†–∞–∑—Ä–µ—à–∞–µ—Ç re-entrancy (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ –≤ loop)
- –í—Å–µ async –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –µ–¥–∏–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ

---

## ‚ö†Ô∏è –†–ò–°–ö–ò –ò –ú–ò–¢–ò–ì–ê–¶–ò–Ø

### –†–∏—Å–∫ 1: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ì–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ü–æ–≤–µ–¥–µ–Ω–∏—è asyncio
**–û—Ü–µ–Ω–∫–∞:** –ù–∏–∑–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º  
**–ö–æ–Ω—Ç—Ä–º–µ—Ä—ã:**
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ (–Ω–µ production)
- ‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ venv –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- ‚úÖ `LLM_MAX_ASYNC=1` –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å

### –†–∏—Å–∫ 2: Race Conditions
**–û—Ü–µ–Ω–∫–∞:** –°—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å  
**–ö–æ–Ω—Ç—Ä–º–µ—Ä—ã:**
- ‚úÖ Single-process —Ä–µ–∂–∏–º FastAPI (–±–µ–∑ gunicorn)
- ‚úÖ –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è Ollama –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ü–∞—É–∑—ã –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏ –≤ `ingest_library.py`

### –†–∏—Å–∫ 3: –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –î—Ä—É–≥–∏–º–∏ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏
**–û—Ü–µ–Ω–∫–∞:** –ù–∏–∑–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å  
**–ö–æ–Ω—Ç—Ä–º–µ—Ä—ã:**
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (LightRAG, FastAPI, Ollama)
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –º–∞–ª—ã—Ö —Ñ–∞–π–ª–∞—Ö –ø–µ—Ä–µ–¥ –ø–æ–ª–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### 1. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (–¢–ï–ö–£–©–ò–ô –®–ê–ì)
- ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ (~90 —Å–µ–∫—É–Ω–¥)
- ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –∏ timestamp'–æ–≤
- ‚è≥ –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—à–∏–±–æ–∫

### 2. –ü–æ–ª–Ω–∞—è –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è (–ü–û–°–õ–ï —É—Å–ø–µ—à–Ω–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏)
```powershell
python ingest_library.py
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- 4 –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `processed`
- –ì—Ä–∞—Ñ >100 –ö–ë
- VDB —Ñ–∞–π–ª—ã >1 –ú–ë –∫–∞–∂–¥—ã–π

### 3. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```powershell
curl -X POST http://localhost:8003/query -H 'Content-Type: application/json' -d '{
  "query": "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç nest_asyncio?",
  "mode": "hybrid"
}'
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –û—Ç–≤–µ—Ç —Å —Ü–∏—Ç–∞—Ç–∞–º–∏ –∏–∑ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

---

## üìö –†–ï–§–ï–†–ï–ù–°–´

1. **nest_asyncio GitHub:** https://github.com/erdewit/nest_asyncio
2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Jupyter:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è notebook –æ–∫—Ä—É–∂–µ–Ω–∏–π
3. **FastAPI + asyncio:** –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –¥–ª—è sync –±–∏–±–ª–∏–æ—Ç–µ–∫ –≤ async –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ

---

## ‚úÖ –ò–¢–û–ì–û–í–´–ô –ß–ï–ö–õ–ò–°–¢

- [x] nest_asyncio —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- [x] –ü–∞—Ç—á –ø—Ä–∏–º–µ–Ω—ë–Ω –∫ `lightrag_server.py`
- [x] –ö—ç—à –æ—á–∏—â–µ–Ω
- [x] –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –æ–∫–Ω–µ
- [x] –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
- [ ] –ì—Ä–∞—Ñ —Å–æ–∑–¥–∞–Ω (–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)
- [ ] Entities/Relations —Å–æ–∑–¥–∞–Ω—ã (–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)
- [ ] –ü–æ–ª–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è (–æ–∂–∏–¥–∞–µ—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏)

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª:** AI Librarian Deployment System  
**–î–∞—Ç–∞:** 22.11.2025 20:05  
**–í–µ—Ä—Å–∏—è:** 1.0
